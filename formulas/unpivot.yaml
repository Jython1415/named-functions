name: UNPIVOT
version: 1.0.2

description: >
  Transforms wide-format data into long-format (tidy data) by unpivoting
  specified columns into attribute-value pairs.

parameters:
  - name: data
    description: Input range including headers (first row must contain column names)
    example: "A1:F100"

  - name: fixedcols
    description: Number of leftmost columns to keep as identifiers (not unpivoted)
    example: 2

  - name: attributecol
    description: Name for the column that will contain the unpivoted header names
    example: "Quarter"

  - name: valuecol
    description: Name for the column that will contain the unpivoted cell values
    example: "Sales"

  - name: select_columns
    description: >
      Specifies which columns to unpivot. Can be array of strings (column names)
      or array of integers (1-based column indices). Empty string unpivots all
      non-fixed columns.
    example: '{"Q1", "Q2", "Q3"}'

  - name: fillna
    description: >
      Value to replace empty cells with in the value column only. Default keeps
      blanks as-is. Different from filtering (use FILTER() wrapper to remove rows).
    example: 0

formula: |
  LET(
    fc, IF(OR(fixedcols = "", ISBLANK(fixedcols)), 1, fixedcols),
    ac, IF(OR(attributecol = "", ISBLANK(attributecol)), "Attribute", attributecol),
    vc, IF(OR(valuecol = "", ISBLANK(valuecol)), "Value", valuecol),
    fillna_val, BLANKTOEMPTY(fillna),

    num_rows, ROWS(data),
    num_cols, COLUMNS(data),

    _validate_dims, IF(OR(num_rows < 2, num_cols < 2),
      ERROR("Data must have at least 2 rows and 2 columns"),
      TRUE
    ),

    _validate_fc, IF(OR(fc < 1, fc >= num_cols),
      ERROR("fixedcols must be between 1 and " & (num_cols - 1)),
      TRUE
    ),

    all_headers, INDEX(data, 1, SEQUENCE(1, num_cols)),

    selected_cols, IF(OR(select_columns = "", ISBLANK(select_columns)),
      SEQUENCE(1, num_cols - fc, fc + 1),
      IF(ISTEXT(INDEX(select_columns, 1, 1)),
        LET(
          flat_selection, FILTER(FLATTEN(select_columns), FLATTEN(select_columns) <> ""),
          matched_indices, MAKEARRAY(1, COLUMNS(flat_selection), LAMBDA(r, c,
            LET(
              search_name, INDEX(flat_selection, 1, c),
              match_result, MATCH(search_name, all_headers, 0),
              IF(ISNA(match_result),
                ERROR("Column '" & search_name & "' not found in headers"),
                match_result
              )
            )
          )),
          matched_indices
        ),
        LET(
          flat_indices, FLATTEN(select_columns),
          _validate_indices, IF(
            OR(
              SUMPRODUCT(--(flat_indices < 1)) > 0,
              SUMPRODUCT(--(flat_indices > num_cols)) > 0
            ),
            ERROR("Column indices must be between 1 and " & num_cols),
            TRUE
          ),
          flat_indices
        )
      )
    ),

    ncols, COLUMNS(selected_cols),
    nrows, num_rows - 1,
    total_output, nrows * ncols,

    unpivoted, MAKEARRAY(total_output, fc + 2, LAMBDA(r, c,
      LET(
        source_row, INT((r - 1) / ncols) + 2,
        col_idx, MOD(r - 1, ncols) + 1,
        value_col_num, INDEX(selected_cols, 1, col_idx),

        cell_value, IF(c <= fc,
          INDEX(data, source_row, c),
          IF(c = fc + 1,
            INDEX(data, 1, value_col_num),
            INDEX(data, source_row, value_col_num)
          )
        ),

        IF(AND(c = fc + 2, cell_value = "", fillna_val <> ""),
          fillna_val,
          cell_value
        )
      )
    )),

    output_headers, MAKEARRAY(1, fc + 2, LAMBDA(r, c,
      IF(c <= fc,
        INDEX(data, 1, c),
        IF(c = fc + 1, ac, vc)
      )
    )),

    VSTACK(output_headers, unpivoted)
  )
